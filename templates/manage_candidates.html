{% extends 'base.html' %}
{% block title %}Manage Candidates{% endblock %}
{% block content %}

<style>
    .view-switcher {
        text-align: right;
        margin-bottom: 16px;
    }
    .view-switcher button {
        background-color: #fff;
        border: 1px solid #eaeaea;
        color: #333;
        padding: 6px 14px;
        border-radius: 6px;
        margin-left: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 15px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    .view-switcher button.active {
        background-color: #f2f2f2;
        color: #007bff;
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.08);
    }
    .table-container {
        padding: 24px;
        background-color: #ffffff;
        border-radius: 12px;
        margin-top: 24px;
    }
    h2 {
        text-align: center;
        font-size: 25px;
        margin-bottom: 20px;
    }
    .table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .table th, .table td {
        padding: 14px 18px;
        border-bottom: 1px solid #eaeaea;
        vertical-align: top;
        position: relative;
        font-size: 15px;
    }
    .table thead th {
        background-color: #f9f9f9;
        font-weight: 600;
        color: #333;
    }
    .table tbody tr:last-child td {
        border-bottom: none;
    }
    .btn-view {
        background-color: #ffffff;
        border: 1px solid #cccccc;
        color: #007bff;
        border-radius: 6px;
        padding: 8px 16px;
        text-decoration: none;
        transition: all 0.2s ease-in-out;
        font-size: 14px;
        margin-right: 6px;
        display: inline-block;
    }
    .btn-view:hover {
        background-color: #f2f2f2;
        border-color: #007bff;
        color: #0056b3;
    }
    .onboarding-status {
        font-size: 13px;
        color: #388e3c;
        margin-top: 4px;
        display: block;
    }
    .text-muted {
        color: #aaaaaa;
        font-size: 13px;
    }
    /* Card view styles */
    .candidate-cards {
        display: none;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 24px;
        flex-direction: row;
    }
    .candidate-card {
        flex: 1 1 calc(33.333% - 20px);
        background-color: #f9f9f9;
        padding: 18px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .candidate-card h3 {
        font-size: 18px;
        margin-bottom: 10px;
    }
    .candidate-card p {
        font-size: 14px;
        margin: 4px 0;
    }
    .candidate-card-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-start;
        gap: 12px;
        align-items: center;
    }
</style>

<div class="table-container">

        <div class="view-switcher">
                <a href="{{ url_for('manage_candidates', view='table') }}" class="view-btn{% if view == 'table' %} active{% endif %}">Table View</a>
                <a href="{{ url_for('manage_candidates', view='card') }}" class="view-btn{% if view == 'card' %} active{% endif %}">Card View</a>
        </div>

        <h2>Manage Candidates</h2>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; flex-wrap:wrap;">
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="positionFilter" style="padding:6px 10px; border:1px solid #cfd8dc; border-radius:5px; font-size:13px; min-width:140px;">
                    <option value="">All Positions</option>
                    {% set positions = candidates_list|map(attribute='position')|list %}
                    {% for pos in positions|unique %}
                        <option value="{{ pos|lower }}">{{ pos }}</option>
                    {% endfor %}
                </select>
                <select id="statusFilter" style="padding:6px 10px; border:1px solid #cfd8dc; border-radius:5px; font-size:13px; min-width:120px;">
                    <option value="">All Statuses</option>
                    {% set statuses = candidates_list|map(attribute='status')|list %}
                    {% for st in statuses|unique %}
                        <option value="{{ st|lower }}">{{ 'Resigned' if st == 'Resigned' else 'Fired' if st == 'Fired' else st }}</option>
                    {% endfor %}
                </select>
            </div>
            <input id="candidateSearch" type="text" placeholder="Search name / position / status" style="padding:6px 10px; border:1px solid #cfd8dc; border-radius:5px; font-size:13px; min-width:220px;">
        </div>

    {% if view == 'card' %}
    <!-- Card View -->
    <div class="candidate-cards" style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 24px; flex-direction: row;">
        {% if candidates_list|length == 0 %}
            <div style="text-align:center; color:#aaa; padding:32px; width:100%;">No candidates found.</div>
        {% else %}
        {% for candidate in candidates_list %}
        <div class="candidate-card">
            <div>
                <h3>{{ candidate.name }}</h3>
                <p><strong>Position:</strong> {{ candidate.position }}</p>
                <p><strong>Status:</strong> {{ 'Resigned' if candidate.status == 'Resigned' else 'Fired' if candidate.status == 'Fired' else candidate.status }}</p>
                {% if candidate.status == 'Hired' and candidate.onboarding %}
                    <p class="onboarding-status">Onboarding: {{ candidate.onboarding_progress }}/{{ candidate.onboarding_total }} steps completed</p>
                {% endif %}
            </div>
            <div class="candidate-card-actions">
                <a href="{{ url_for('candidate_profile', candidate_id=candidate.id) }}" class="btn-view">View</a>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    {% else %}
    <!-- Table View -->
    <table class="table" id="candidatesTable">
        <thead>
            <tr>
                <th>Candidate Name</th>
                <th>Position</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="candidatesTbody">
            {% for candidate in candidates_list %}
            <tr data-name="{{ candidate.name|lower }}" data-position="{{ candidate.position|lower }}" data-status="{{ candidate.status|lower }}" class="cand-row">
                <td>{{ candidate.name }}</td>
                <td>{{ candidate.position }}</td>
                <td>
                    {{ 'Resigned' if candidate.status == 'Resigned' else 'Fired' if candidate.status == 'Fired' else candidate.status }}
                    {% if candidate.status == 'Hired' and candidate.onboarding %}
                        <span class="onboarding-status">Onboarding: {{ candidate.onboarding_progress }}/{{ candidate.onboarding_total }} steps completed</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('candidate_profile', candidate_id=candidate.id) }}" class="btn-view">View</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="text-muted">No candidates found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
<style>
    .fade-in { animation: fadeInRow 0.28s cubic-bezier(.4,.14,.3,1) forwards; }
    .fade-out { animation: fadeOutRow 0.22s cubic-bezier(.55,.06,.68,.19) forwards; }
    @keyframes fadeInRow {
        0% { opacity:0; transform:translateY(16px); }
        100% { opacity:1; transform:translateY(0); }
    }
    @keyframes fadeOutRow {
        0% { opacity:1; transform:translateY(0); }
        100% { opacity:0; transform:translateY(-12px); }
    }
    .cand-row.fade-in, .cand-row.fade-out { will-change: transform, opacity; }
    tbody#candidatesTbody .cand-row.fade-in { animation-delay: calc(var(--seq-index, 0) * 36ms); }
    tbody#candidatesTbody .cand-row.fade-out { animation-delay: calc(var(--seq-index, 0) * 36ms); }
    .animating { pointer-events:none; }
</style>
<script>
// Animated search filter for candidates
const candRows = Array.from(document.querySelectorAll('#candidatesTbody .cand-row'));
let filterAnimToken = 0;
const STAGGER = 36;
const EXIT_DUR = 220;
const ENTER_DUR = 280;
function orchestrateSequence(exiting, entering, done){
    exiting.forEach(el=>{ el.classList.remove('fade-in','fade-out'); });
    entering.forEach(el=>{ el.classList.remove('fade-in','fade-out'); });
    exiting.forEach((el,i)=>{
        el.style.setProperty('--seq-index', i);
        el.classList.add('fade-out');
        el.dataset.visible='';
        el.addEventListener('animationend', ()=>{ el.classList.remove('fade-out'); el.style.display='none'; }, {once:true});
    });
    const exitTotal = exiting.length ? EXIT_DUR + (exiting.length-1)*STAGGER : 0;
    setTimeout(()=>{
        entering.forEach((el,i)=>{
            el.style.display='';
            el.dataset.visible='1';
            el.style.setProperty('--seq-index', i);
            void el.offsetWidth;
            el.classList.add('fade-in');
            el.addEventListener('animationend', ()=>{ el.classList.remove('fade-in'); }, {once:true});
        });
        const enterTotal = entering.length ? ENTER_DUR + (entering.length-1)*STAGGER : 0;
        setTimeout(()=> done && done(), enterTotal);
    }, exitTotal + 6);
}
function applyCandidateFilters(){
    const myToken = ++filterAnimToken;
    const q = document.getElementById('candidateSearch').value.trim().toLowerCase();
    const pos = document.getElementById('positionFilter').value;
    const stat = document.getElementById('statusFilter').value;
    let filtered = candRows.filter(r=>{
        const matchesQ = !q || r.dataset.name.includes(q) || r.dataset.position.includes(q) || r.dataset.status.includes(q);
        const matchesPos = !pos || r.dataset.position === pos;
        const matchesStat = !stat || r.dataset.status === stat;
        return matchesQ && matchesPos && matchesStat;
    });
    const exiting = [], entering = [];
    candRows.forEach(r=>{
        const shouldShow = filtered.includes(r);
        const visible = r.dataset.visible==='1';
        if(visible && !shouldShow) exiting.push(r);
        else if(!visible && shouldShow) entering.push(r);
    });
    orchestrateSequence(exiting, entering, ()=>{ if(myToken !== filterAnimToken) return; });
}
let debounceTimer;
function scheduleCandidateFilter(){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(applyCandidateFilters, 140);
}
document.getElementById('candidateSearch').addEventListener('input', scheduleCandidateFilter);
document.getElementById('positionFilter').addEventListener('change', scheduleCandidateFilter);
document.getElementById('statusFilter').addEventListener('change', scheduleCandidateFilter);
applyCandidateFilters();
</script>
    {% endif %}
</div>

<style>
    .view-btn {
        background-color: #fff;
        border: 1px solid #eaeaea;
        color: #333;
        padding: 6px 14px;
        border-radius: 6px;
        margin-left: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 15px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        text-decoration: none;
        display: inline-block;
    }
    .view-btn.active {
        background-color: #f2f2f2;
        color: #007bff;
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.08);
    }
</style>

{% endblock %}
